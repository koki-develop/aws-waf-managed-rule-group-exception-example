# 概要

AWS WAF ACL でマネージドルールの特定のルールを特定の条件下で無効にする Terraform のサンプルコード。
当該プロジェクトでは `/hello.txt` というパスに対して `AWSManagedRulesCommonRuleSet` ルールセットの `NoUserAgent_HEADER` ルールが適用されないように設定している。

# 検証手順

## リソースの作成

```
$ cd terraform
$ terraform init
$ terraform apply
```

## WAF の動作確認

```sh
$ curl 'https://<CLOUDFRONT_DISTRIBUTION_DOMAIN>/hello.txt' -H 'User-Agent: curl'
Hello, World

# /hello.txt ではNoUserAgent_HEADER ルールによってブロックされない
$ curl 'https://<CLOUDFRONT_DISTRIBUTION_DOMAIN>/hello.txt' -H 'User-Agent:'
Hello, World
```

```sh
$ curl 'https://<CLOUDFRONT_DISTRIBUTION_DOMAIN>/goodbye.txt' -H 'User-Agent: curl'
Goodbye, World

# 他のパスでは NoUserAgent_HEADER ルールによってブロックされる
$ curl 'https://<CLOUDFRONT_DISTRIBUTION_DOMAIN>/goodbye.txt' -H 'User-Agent:'
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Request blocked.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: ********************************************************
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
```

# 参考

- [[AWS WAF] マネージドルールグループに対して例外条件を設定する | DevelopersIO](https://dev.classmethod.jp/articles/aws-waf-managed-rule-group-exception-conditions/)
- [AWS WAF によってブロックされたファイルのアップロード | AWS re:Post](https://repost.aws/ja/knowledge-center/waf-upload-blocked-files)
